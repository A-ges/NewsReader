<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Newsreader (Distributed)</title>
  <style>
    :root{
      --accent:#2563eb;
      --bg:#f1f5f9;
      --card:#ffffff;
      --text:#1e293b;
      --muted:#475569;
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;color:var(--text);background:var(--bg)}
    body{display:flex;align-items:center;justify-content:center;padding:32px}
    .container{width:960px;max-width:96%;background:var(--card);padding:24px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
    h1{margin:0 0 16px;font-size:40px;font-weight:800;text-align:center;color:var(--accent)}
    p.lead{margin:0 0 18px;color:var(--muted);text-align:center}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:#f8fafc;padding:18px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px;font-weight:600}
    .input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1;background:#ffffff;color:var(--text)}
    .row{display:flex;gap:10px}
    .muted{color:var(--muted);font-size:13px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;border:none;font-weight:600}
    .btn:active{transform:translateY(1px)}
    .extra{margin-top:16px}
    .chevron{display:inline-block;transform:rotate(0)}
    .extra-panel{overflow:hidden;max-height:0;transition:max-height .28s ease}
    .extra-panel.open{max-height:500px}
    .preview{background:#f1f5f9;padding:10px;border-radius:8px;margin-top:10px}
    .audio-block{margin-top:12px}
    .footer{margin-top:14px;background:#f1f5f9;padding:10px;border-radius:10px}
    .small{font-size:13px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>Newsreader</h1>
    <p class="lead">Enter your Google API Key, then upload an article (PDF, JPG, JPEG) or paste a public link. Use <strong>Extra Options</strong> to adjust the summary.</p>

    <div class="grid">
      <div class="card" aria-labelledby="form-heading">
        <h2 id="form-heading" style="margin-top:0;font-size:16px">Input</h2>

        <label for="apiKeyInput">Your Google API Key</label>
        <input id="apiKeyInput" class="input" type="password" placeholder="Enter your Gemini API Key here" />
        <div style="height:10px"></div>

        <label for="urlInput">Article URL (open access)</label>
        <input id="urlInput" class="input" type="url" placeholder="https://example.com/article" />

        <div style="height:10px"></div>

        <label for="fileInput">Or upload file (pdf, jpg, jpeg)</label>
        <input id="fileInput" class="input" type="file" accept="application/pdf,image/jpeg,image/jpg" />

        <div id="filePreview" class="preview" style="display:none"></div>

        <div class="extra">
          <button id="toggleExtra" class="btn" aria-expanded="false" aria-controls="extraPanel">
            <span id="chev" class="chevron">▸</span> Extra Options
          </button>

          <div id="extraPanel" class="extra-panel" aria-hidden="true">
            <div style="margin-top:12px">
              <label><strong>Summary Length</strong></label>
              <div class="choice">
                <select id="lengthSelect" class="input" aria-label="Summary length">
                  <option value="SHORT_LENGTH">Short</option>
                  <option value="MEDIUM_LENGTH" selected>Medium (default)</option>
                  <option value="LONG_LENGTH">Long</option>
                  <option value="FULL_TEXT">Full</option>
                </select>
              </div>

              <label style="margin-top:8px"><strong>Language Style</strong></label>
              <div class="choice">
                <select id="styleSelect" class="input" aria-label="Language style">
                  <option value="NORMAL_WORDS" selected>Normal words (default)</option>
                  <option value="EASIER_WORDS">Easier words</option>
                </select>
              </div>

              <!-- PICTURE DETAIL SECTION HAS BEEN REMOVED -->

            </div>
          </div>
        </div>

        <div style="height:14px"></div>
        <div class="row">
          <button id="generateBtn" class="btn" aria-label="Generate">Generate</button>
          <button id="clearBtn" class="btn" style="background:#64748b;color:#fff">Clear</button>
        </div>

        <div id="status" class="muted small" style="margin-top:12px">Ready.</div>
      </div>

      <div class="card">
        <h2 style="margin-top:0;font-size:16px">Result</h2>
        <div id="resultText" class="preview small">No result yet. After a job is submitted, the result will appear here once processing is complete.</div>

        <div id="audioArea" class="audio-block" style="display:none">
          <div style="margin-top:10px">Listen / download:</div>
          <audio id="audioPlayer" controls style="width:100%;margin-top:8px"></audio>
          <div style="margin-top:8px"><a id="downloadLink" download="newsreader_readout.mp3">Download MP3</a></div>
        </div>

        <div class="footer">
          <h3 style="margin:6px 0 6px;font-size:14px">Review</h3>
          <div class="muted small">Tell us how the summary & readout performed.</div>
          <textarea id="reviewText" style="width:100%;min-height:90px;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;color:var(--text)" placeholder="Write a short review of the output and website experience"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="submitReview" class="btn">Submit review</button>
            <button id="resetReview" class="btn" style="background:#64748b">Clear</button>
          </div>
          <div id="reviewStatus" class="muted small" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiKeyInput=document.getElementById('apiKeyInput');
    const fileInput=document.getElementById('fileInput');
    const urlInput=document.getElementById('urlInput');
    const filePreview=document.getElementById('filePreview');
    const toggleExtra=document.getElementById('toggleExtra');
    const extraPanel=document.getElementById('extraPanel');
    const chev=document.getElementById('chev');
    const generateBtn=document.getElementById('generateBtn');
    const clearBtn=document.getElementById('clearBtn');
    const lengthSelect=document.getElementById('lengthSelect');
    const styleSelect=document.getElementById('styleSelect');
    // const pictureDetail removed
    const status=document.getElementById('status');
    const resultText=document.getElementById('resultText');
    const audioArea=document.getElementById('audioArea');
    const audioPlayer=document.getElementById('audioPlayer');
    const downloadLink=document.getElementById('downloadLink');
    const reviewText=document.getElementById('reviewText');
    const submitReview=document.getElementById('submitReview');
    const reviewStatus=document.getElementById('reviewStatus');

    let pollingInterval;

    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    async function pollJobStatus(jobId) {
      status.innerText = `Job submitted. Processing... (ID: ${jobId.substring(0, 8)})`;
      pollingInterval = setInterval(async () => {
        try {
          const resp = await fetch(`/status/${jobId}`);
          if (!resp.ok) {
            status.innerText = `Error checking status (Server status: ${resp.status}).`;
            stopPolling();
            return;
          }
          const data = await resp.json();
          const currentStatus = data.status || 'unknown';
          status.innerText = `Job Status: ${currentStatus}`;
          if (currentStatus === 'finished') {
            stopPolling();
            status.innerText = 'Processing complete! Audio is ready.';
            resultText.innerText = 'Your audio has been generated.';
            audioPlayer.src = data.result_url;
            downloadLink.href = data.result_url;
            downloadLink.download = `newsreader_${jobId.substring(0, 8)}.mp3`;
            audioArea.style.display = 'block';
          } else if (currentStatus === 'failed') {
            stopPolling();
            status.innerText = 'Job failed. See worker terminal logs for details.';
            resultText.innerText = `An error occurred during processing: ${data.error || 'Unknown error'}`;
          }
        } catch (err) {
          status.innerText = 'Network error while checking status.';
          stopPolling();
        }
      }, 5000);
    }

    toggleExtra.addEventListener('click',()=> {
        const open=extraPanel.classList.toggle('open');
        toggleExtra.setAttribute('aria-expanded',open);
        extraPanel.setAttribute('aria-hidden',!open);
        chev.style.transform=open?'rotate(90deg)':'rotate(0deg)';
    });

    fileInput.addEventListener('change',()=>{
      const f=fileInput.files[0];
      if(!f){filePreview.style.display='none';filePreview.innerHTML='';return}
      filePreview.style.display='block';
      const ext=f.name.split('.').pop().toLowerCase();
      if(ext==='pdf'){
        filePreview.innerHTML=`<div class='small'>PDF selected: ${escapeHtml(f.name)} (${Math.round(f.size/1024)} KB)</div>`;
      }else if(ext==='jpg'||ext==='jpeg'){
        const img=document.createElement('img');
        img.style.maxWidth='100%';img.style.borderRadius='6px';
        const url=URL.createObjectURL(f);
        img.src=url;
        filePreview.innerHTML='';
        filePreview.appendChild(img);
      }else{
        filePreview.innerHTML=`<div class='small'>File selected: ${escapeHtml(f.name)}</div>`;
      }
    });

    clearBtn.addEventListener('click',()=>{
      stopPolling();
      fileInput.value='';urlInput.value='';apiKeyInput.value='';filePreview.style.display='none';filePreview.innerHTML='';resultText.innerText='No result yet.';audioArea.style.display='none';reviewText.value='';status.innerText='Ready.';
    });

    function buildOptionsList(){
      const list=[];
      list.push(lengthSelect.value);
      list.push(styleSelect.value);
      // pictureDetail line has been removed
      return list;
    }

    function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    generateBtn.addEventListener('click', async () => {
      stopPolling();
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        status.innerText = 'Please enter your Google API Key.';
        return;
      }
      const opts = buildOptionsList();
      const fd = new FormData();
      fd.append('api_key', apiKey);
      fd.append('options', JSON.stringify(opts));
      if (fileInput.files && fileInput.files[0]) {
        fd.append('file', fileInput.files[0]);
      } else if (urlInput.value.trim()) {
        fd.append('url', urlInput.value.trim());
      } else {
        status.innerText = 'Please provide a URL or upload a file.';
        return;
      }
      status.innerText = 'Submitting job to the queue...';
      resultText.innerText = 'Waiting for job to be accepted...';
      audioArea.style.display = 'none';
      try {
        const resp = await fetch('/submit-job', { method: 'POST', body: fd });
        if (!resp.ok) {
          const errorJson = await resp.json();
          status.innerText = `Error submitting job: ${errorJson.error || 'Unknown error'}`;
          return;
        }
        const data = await resp.json();
        if (data.job_id) {
          pollJobStatus(data.job_id);
        } else {
          status.innerText = 'Failed to get Job ID from server.';
        }
      } catch (err) {
        status.innerText = `Network error: ${err.message}`;
      }
    });

    submitReview.addEventListener('click',async()=>{
      const text = reviewText.value.trim();
      if (!text) {
        reviewStatus.innerText = 'Write something before submitting.';
        return;
      }
      reviewStatus.innerText = 'Sending review...';
      try {
        const r = await fetch('/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ review: text, timestamp: new Date().toISOString() })
        });
        if (r.ok) {
          reviewStatus.innerText = 'Thanks — review submitted.';
          reviewText.value = '';
        } else {
          reviewStatus.innerText = 'Failed to submit review.';
        }
      } catch (e) {
        reviewStatus.innerText = 'Network error while sending review.';
      }
    });
  </script>
</body>
</html>
